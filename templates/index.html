<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GeoChessr{% if is_daily %} - Daily{% endif %}</title>
  <link rel="stylesheet" href="{{ url_for('styles', filename='main.css') }}">
</head>
<body>
  <main class="container">
    <h1 class="page-title">GeoChessr.io</h1>
    <div class="boards">
      <div class="board-wrapper">
        <div id="labelLeft" class="board-label">Find these pieces</div>
        <div class="board-shell">
          <div id="board" class="board" aria-label="mock chessboard"></div>
        </div>
        <!-- Lichess embed shell (shown in feedback when toggled on) -->
        <div id="lichessShell" class="board-shell" style="display:none;">
          <iframe id="lichessIframe" class="lichess-iframe" allowtransparency="true" frameborder="0"></iframe>
        </div>
      </div>
      <div class="board-wrapper">
        <div id="labelRight" class="board-label">On the chessboard</div>
        <div id="board8" class="board board-8" aria-label="8 by 8 overlay board"></div>
      </div>
      <aside class="meta" aria-label="Game meta">
        <div class="meta-card">
          <div id="metaDailyTitle" class="meta-title" style="display: none;">Daily Run</div>
          {% if not is_single_puzzle %}
          <div class="meta-row"><span class="meta-label">Puzzle #</span><span id="metaPuzzleNum" class="meta-value">{{ (run_index + 1) if run_index is not none else '' }}/{{ run_len if run_len else '' }}</span></div>
          {% endif %}
          <div id="metaRowResult" class="meta-row"><span class="meta-label">Result</span><span id="metaResult" class="meta-value">{{ (game_meta.result or '') if game_meta else '' }}</span></div>
          <div id="metaRowWhiteElo" class="meta-row"><span class="meta-label">White ELO</span><span id="metaWhiteElo" class="meta-value">{{ (game_meta.whiteElo or '') if game_meta else '' }}</span></div>
          <div id="metaRowBlackElo" class="meta-row"><span class="meta-label">Black ELO</span><span id="metaBlackElo" class="meta-value">{{ (game_meta.blackElo or '') if game_meta else '' }}</span></div>
          <div id="metaRowMoveNum" class="meta-row"><span class="meta-label">Move #</span><span id="metaMove" class="meta-value">{{ (game_meta.moveNum or '') if game_meta else '' }}</span></div>
          <div id="metaRowOpening" class="meta-row"><span class="meta-label">Opening</span><span id="metaOpening" class="meta-value meta-small">{{ (game_meta.opening_name or '') if game_meta else '' }}</span></div>
          <div id="metaRowWhitePlayer" class="meta-row"><span class="meta-label">White</span><span id="metaWhitePlayer" class="meta-value">{{ (game_meta.whitePlayer or '') if game_meta else '' }}</span></div>
          <div id="metaRowBlackPlayer" class="meta-row"><span class="meta-label">Black</span><span id="metaBlackPlayer" class="meta-value">{{ (game_meta.blackPlayer or '') if game_meta else '' }}</span></div>
          <div id="metaRowYear" class="meta-row"><span class="meta-label">Year</span><span id="metaYear" class="meta-value">{{ (game_meta.year or '') if game_meta else '' }}</span></div>
          <div id="metaRowSuccesses" class="meta-row"><span class="meta-label">Successes</span><span id="metaSuccesses" class="meta-value">{{ (game_meta.successes or 0) if game_meta else 0 }}</span></div>
          <div id="metaRowFails" class="meta-row"><span class="meta-label">Fails</span><span id="metaFails" class="meta-value">{{ (game_meta.fails or 0) if game_meta else 0 }}</span></div>
          <div id="metaRowPgn" class="meta-row"><span class="meta-label">PGN</span><span class="meta-value"><a id="metaPgnLink" href="#" download> </a></span></div>
          <div id="metaRowUrl" class="meta-row"><span class="meta-label">URL</span><span class="meta-value"><a id="metaGameLink" href="#" target="_blank" rel="noopener noreferrer"></a></span></div>
        </div>
        <div id="feedbackCard" class="feedback-card" style="display: none;">
          <div id="feedbackTitle" class="status-title"></div>
          <div id="runSummary" class="run-summary" style="display: none;">
            <div id="runSummaryBoxes" class="run-summary-boxes"></div>
            <div id="runSummaryScore" class="run-summary-score"></div>
          <div id="runSummaryTime" class="run-summary-time"></div>
            <button id="copyRunLinkBtn" class="copy-link-btn" aria-label="Copy run link">Copy run link</button>
          </div>
          <button id="nextButton" class="next-btn" aria-label="Next">Next</button>
        </div>
      </aside>
    </div>

    <section class="controls">
      <div id="error" class="error" role="status" aria-live="polite"></div>
    </section>
  </main>

  <!-- Bottom menu -->
  <nav class="bottom-menu" aria-label="Utility menu">
    <button id="btnNewRun" class="menu-btn" type="button">New Run</button>
    <button id="btnGithub" class="menu-btn" type="button">GitHub</button>
    <button id="btnAbout" class="menu-btn" type="button">About</button>
    <button id="btnDaily" class="menu-btn" type="button">Daily</button>
    <button id="btnLichessBoard" class="menu-btn" type="button" aria-pressed="false">Show Game</button>
  </nav>

  <!-- New Run modal -->
  <div id="runModal" class="modal-overlay" style="display:none;">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="runModalTitle">
      <div class="modal-header">
        <h3 id="runModalTitle" class="modal-title">Create a new run</h3>
        <button id="runModalClose" class="modal-close" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label class="form-label">Mode</label>
          <div class="form-hint">
            <label><input type="radio" name="rsMode" id="rsModeExisting" value="existing" checked /> Play an existing run</label>
            <label style="margin-left: 16px;"><input type="radio" name="rsMode" id="rsModeCreate" value="create" /> Create a new run</label>
          </div>
        </div>

        <!-- Existing run section -->
        <div id="rsExistingSection">
          <div class="form-row">
            <label class="form-label">Minimum times completed</label>
            <input id="rsMinCompleted" type="range" min="0" max="50" value="10" />
            <div class="form-hint">At least <span id="rsMinCompletedVal">10</span> times</div>
          </div>
          <div id="runModalError" class="error"></div>
        </div>

        <!-- Create new run section -->
        <div id="rsCreateSection" style="display:none;">
          <div class="form-row">
            <label class="form-label">Difficulty</label>
            <input id="rsDifficulty" type="range" min="0" max="3" value="1" step="1" />
            <div class="form-hint" id="rsDifficultyLabel">Normal (0%–30%)</div>
          </div>

          <div class="form-row">
            <label class="form-label">Number of puzzles</label>
            <input id="rsNPuzzles" type="range" min="1" max="50" value="10" />
            <div class="form-hint">Selected: <span id="rsNPuzzlesVal">10</span></div>
          </div>

          <div class="form-row">
            <label class="form-label">Move range</label>
            <div class="dual-range">
              <input id="rsMinMove" type="range" min="0" max="100" value="5" />
              <input id="rsMaxMove" type="range" min="0" max="100" value="20" />
            </div>
            <div class="form-hint">From <span id="rsMinMoveVal">5</span> to <span id="rsMaxMoveVal">20</span></div>
          </div>

          <div class="form-row">
            <label class="form-label">Game source</label>
            <div class="form-hint">
              <label><input type="radio" name="rsSource" id="rsSourceLichess" value="lichess" checked /> lichess</label>
              <label style="margin-left: 16px;"><input type="radio" name="rsSource" id="rsSourceMasters" value="world_champion" /> masters</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="runCreateBtn" class="primary-btn" type="button">Play random run</button>
      </div>
    </div>
  </div>

  <script>
    window.INITIAL_SUBFEN = {{ (initial_subfen or '')|tojson }};
    window.GEOCHESS_ID = {{ (geochess_id or '')|tojson }};
    window.LAST_MOVE_CELLS = {{ (last_move_cells or [])|tojson }};
    window.TOP_LEFT_LIGHT = {{ (top_left_light if top_left_light is not none else '')|tojson }};
    window.RUN_ID = {{ (run_id or '')|tojson }};
    window.RUN_INDEX = {{ (run_index if run_index is not none else 0)|tojson }};
    window.RUN_LEN = {{ (run_len if run_len is not none else 0)|tojson }};
    window.RUN_PUZZLE_IDS = {{ (run_puzzle_ids or [])|tojson }};
    window.PRIOR_SUBMISSION = {{ (prior_submission or None)|tojson }};
    window.ALL_SUBMISSIONS = {{ (all_submissions or [])|tojson }};
    window.IS_DAILY = {{ (is_daily or False)|tojson }};
    window.IS_SINGLE_PUZZLE = {{ (is_single_puzzle or False)|tojson }};
    window.METADATA_FIELDS = {{ (metadata_fields or [])|tojson }};
    window.RUN_STATS = {{ ({
      'completedCount': (run_completed_count if run_completed_count is not none else 0),
      'avgTimeSeconds': (run_avg_time_seconds if run_avg_time_seconds is not none else None),
      'avgCorrectCount': (run_avg_correct_count if run_avg_correct_count is not none else None),
    })|tojson }};
  </script>
  <script src="{{ url_for('scripts', filename='main.js') }}"></script>
</body>
</html>


